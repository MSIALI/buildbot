# Circle CI configuration file
# https://circleci.com/docs/

machine:
  python:
    version: 2.7.11

dependencies:
  pre:
    - sudo apt-get update; sudo apt-get install libenchant-dev python3-dev
  override:
    - pip install -U pip
    - pip install -r requirements-ci.txt
    - pip install -r requirements-cidocs.txt

test:
  override:
    - make docs
    # pyinstaller: build the buildbotworker in a special virtualenv
    # circle ci pythons do not include the necessary dynamic libraries for pyinstaller
    - virtualenv -p /usr/bin/python3.4 .venv/
    - .venv/bin/pip install twisted[tls] -e worker pyinstaller
    - .venv/bin/pyinstaller -F pyinstaller/buildbot-worker.spec
    # we test the new generated binary with the global virtualenv
    - SANDBOXED_WORKER_PATH=`pwd`/dist/buildbot-worker trial --reporter=text --rterrors buildbot.test.integration.interop

general:
  artifacts:
    - "master/docs/_build/html/"
    - "dist"
